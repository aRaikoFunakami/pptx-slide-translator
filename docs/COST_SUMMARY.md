# コスト集計レポート

`cost_summary.py` スクリプトは、PPTX翻訳サービスの使用コストを日次・週次・月次で集計し、レポートを生成します。

## 機能

### 集計期間

- **日次集計**: 日ごとのコスト、トークン数、翻訳回数
- **週次集計**: 週ごとの集計（ISO週番号形式: YYYY-Www）
- **月次集計**: 月ごとの集計（YYYY-MM形式）
- **直近7日間のサマリー**: 最近の使用傾向を把握

### 出力情報

各集計には以下の情報が含まれます：

- 期間（日付/週/月）
- 費用（USD、6桁精度）
- 使用トークン数
- 翻訳回数
- 合計値

## 使用方法

### 基本的な使用

```bash
# 全期間の集計を表示（日次・週次・月次すべて）
uv run python scripts/cost_summary.py

# または
python scripts/cost_summary.py
```

### 期間を指定した集計

```bash
# 日次集計のみ表示
uv run python scripts/cost_summary.py --period daily

# 週次集計のみ表示
uv run python scripts/cost_summary.py --period weekly

# 月次集計のみ表示
uv run python scripts/cost_summary.py --period monthly
```

### ファイルに出力

```bash
# 指定したファイルに出力
uv run python scripts/cost_summary.py --output logs/report.txt

# 自動生成されたファイル名で出力（タイムスタンプ付き）
uv run python scripts/cost_summary.py --output logs/cost_summary_$(date +%Y%m%d).txt
```

### カスタムメトリクスファイルを指定

```bash
# デフォルト以外のメトリクスファイルを使用
uv run python scripts/cost_summary.py --metrics-file path/to/custom_metrics.jsonl
```

## 出力例

```
📊 コスト集計レポート
======================================================================
生成日時: 2025-11-06 17:31:25
データソース: logs/metrics.jsonl
総レコード数: 12


📅 日次コスト集計
======================================================================
期間                   費用 (USD)        トークン数           翻訳回数      
----------------------------------------------------------------------
2025-11-06           $0.006093       30,047          8         
2025-11-04           $0.000000       0               3         
2025-10-31           $0.000000       0               1         
----------------------------------------------------------------------
合計                   $0.006093       30,047          12        
======================================================================

📆 週次コスト集計
======================================================================
期間                   費用 (USD)        トークン数           翻訳回数      
----------------------------------------------------------------------
2025-W44             $0.006093       30,047          11        
2025-W43             $0.000000       0               1         
----------------------------------------------------------------------
合計                   $0.006093       30,047          12        
======================================================================

📈 月次コスト集計
======================================================================
期間                   費用 (USD)        トークン数           翻訳回数      
----------------------------------------------------------------------
2025-11              $0.006093       30,047          11        
2025-10              $0.000000       0               1         
----------------------------------------------------------------------
合計                   $0.006093       30,047          12        
======================================================================

🔍 直近7日間のサマリー
======================================================================
期間: 2025-10-31 ～ 2025-11-06
総費用: $0.006093
総トークン数: 30,047
総翻訳回数: 12
アクティブ日数: 3 日
1日あたり平均費用: $0.002031
======================================================================
```

## コマンドラインオプション

| オプション | 説明 | デフォルト値 |
|-----------|------|------------|
| `--period` | 集計期間タイプ: `daily`, `weekly`, `monthly`, `all` | `all` |
| `--metrics-file` | メトリクスファイルのパス | `logs/metrics.jsonl` |
| `--output` | 出力ファイルパス（指定しない場合は標準出力） | なし |
| `--help` | ヘルプメッセージを表示 | - |

## 定期実行の設定

### 日次レポートをメールで送信

```bash
# crontabに追加（毎日午前9時に実行）
0 9 * * * cd /path/to/pptx-slide-translator && uv run python scripts/cost_summary.py --period daily --output logs/daily_report.txt && mail -s "Daily Cost Report" your@email.com < logs/daily_report.txt
```

### 週次レポート（毎週月曜日）

```bash
# 毎週月曜日の午前9時に週次レポート
0 9 * * 1 cd /path/to/pptx-slide-translator && uv run python scripts/cost_summary.py --period weekly --output logs/weekly_report.txt
```

### 月次レポート（毎月1日）

```bash
# 毎月1日の午前9時に月次レポート
0 9 1 * * cd /path/to/pptx-slide-translator && uv run python scripts/cost_summary.py --period monthly --output logs/monthly_report.txt
```

## データソース

スクリプトは `logs/metrics.jsonl` から以下のフィールドを読み取ります：

- `timestamp`: ISO8601形式のタイムスタンプ
- `status`: 翻訳ステータス（`completed`のみ集計対象）
- `total_cost_usd`: 翻訳にかかった費用（USD）
- `total_tokens`: 使用したトークン数

## トラブルシューティング

### メトリクスファイルが見つからない

```
⚠️  メトリクスファイルが見つかりません: logs/metrics.jsonl
```

**解決方法**: 
- ファイルパスが正しいか確認
- 翻訳を実行してメトリクスデータを生成
- `--metrics-file` オプションで正しいパスを指定

### データが表示されない

**原因**: 
- メトリクスファイルにデータがない
- すべてのレコードのステータスが `completed` 以外

**解決方法**:
- 少なくとも1回の翻訳を完了させる
- メトリクスファイルの内容を確認: `cat logs/metrics.jsonl`

### タイムスタンプ解析エラー

```
⚠️  タイムスタンプ解析エラー: 2025-11-06T12:34:56Z - ...
```

**解決方法**:
- メトリクスファイルのフォーマットを確認
- ISO8601形式（`YYYY-MM-DDTHH:MM:SS`）であることを確認

## 関連スクリプト

- `monthly_cost_report.py`: 月次コストレポートをメール/Slack通知
- `extract_transactions.py`: トランザクション詳細を抽出
- `add_current_cumulative.py`: 累積メトリクスを追加

## 技術仕様

### 週番号の計算

ISO 8601週番号を使用：
- 週は月曜日から始まる
- 年の最初の週は、その年の最初の木曜日を含む週
- フォーマット: `YYYY-Www`（例: `2025-W44`）

### 集計ロジック

1. `logs/metrics.jsonl` を1行ずつ読み込み
2. `status == 'completed'` のレコードのみを集計対象
3. タイムスタンプをパースして期間キーを生成
4. 各期間ごとに cost, tokens, count を累積
5. 期間の新しい順にソート表示

### パフォーマンス

- メモリ効率: 大規模なログファイルでも効率的に処理
- 処理速度: 10,000レコードを約1秒で集計（Python 3.12基準）

## ライセンス

このスクリプトはプロジェクト本体と同じライセンスに従います。
